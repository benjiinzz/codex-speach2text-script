#!/usr/bin/env bash
set -euo pipefail

MIC_ID="59"

UID_NUM="$(id -u)"
XDG_RUNTIME_DIR="${XDG_RUNTIME_DIR:-/run/user/$UID_NUM}"
RUNDIR="$XDG_RUNTIME_DIR/codex_ptt"

mkdir -p "$RUNDIR"

WAV="$RUNDIR/voice.wav"
PIDFILE="$RUNDIR/rec.pid"
LOG="$RUNDIR/ptt.log"

notify() { command -v notify-send >/dev/null 2>&1 && notify-send "Codex PTT" "$1" || true; }

# If already recording, do nothing
if [[ -f "$PIDFILE" ]] && kill -0 "$(cat "$PIDFILE")" 2>/dev/null; then
  notify "Already recording"
  exit 0
fi

# New cycle: truncate log and reset wav
: > "$LOG"
rm -f "$WAV"

{
  echo "---- START $(date) ----"
  echo "cwd=$(pwd)"
  echo "MIC_ID=$MIC_ID"
  echo "RUNDIR=$RUNDIR"
  echo "WAV=$WAV"
} >> "$LOG"

pw-record --target "$MIC_ID" --rate 16000 --channels 1 --format s16 "$WAV" >>"$LOG" 2>&1 &
pid=$!
echo "$pid" > "$PIDFILE"
echo "pw-record pid=$pid" >> "$LOG"

sleep 0.05
if kill -0 "$pid" 2>/dev/null; then
  notify "Recordingâ€¦"
else
  echo "pw-record died immediately" >> "$LOG"
  notify "Recording failed (see ptt.log)"
fi
